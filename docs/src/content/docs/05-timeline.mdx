---
title: タイムラインを作る
---

import { Aside } from "@astrojs/starlight/components"

ここからはいよいよTwitter風アプリを作っていきます。
まずはタイムラインを表示するところから作っていきましょう。

## APIの確認

まずは今回使用するAPIの仕様を確認します。
Postmanで次のリクエストを送信してください。

- メソッド: GET
- URL: `https://micro-communication-chat.tuatmcc-com.workers.dev/api/posts`

すると、次のようなレスポンスが返ってきます。(きれいに表示されない場合は、Bodyの下のセレクタを「JSON」にしてください)

![](./assets/postman-posts.png)

このレスポンスの中身を見ると、次のようなデータが返ってきていることがわかります。

```jsonc
{
	"posts": [
		{
			"id": "01K1PRZ7QRBRTFEGV0M9DRC7XZ", // 投稿のID(投稿ごとに一意)
			"name": "わたなべ", // 投稿者の名前(nullの場合もある)
			"content": "ラーメン食べたくなってきた🍜誰か一緒に行かない？", // 投稿の内容
			"likes": 15, // いいねの数
			"replies": 1, // 返信の数
			"createdAt": 1754184785656 // 投稿の作成日時(UNIXエポックミリ秒)
		}
		// ...
	]
}
```

これは**JSON**というデータ形式で、APIで広く使われる形式です。
JSONはJavaScriptの構文に非常に似ており、JavaScriptの場合はJSON↔JavaScriptの変換が簡単にできます。

なお、このAPIはデフォルトでは最新50件の投稿のみを返します。
もっと前の投稿を取得したり、取得件数を変えたい場合はクエリパラメータの追加が必要です。
詳しいAPIの仕様や、他にどんなAPIがあるかは https://micro-communication-chat.tuatmcc-com.workers.dev/docs を参照してください。
このドキュメントからでもAPIを試すことができます。

## アプリでAPIを叩いてみる

次はReactアプリでAPIからデータを取得してみましょう。
Reactの標準機能だけでもAPIは使えますが、少し複雑になってしまいます。
そこで、APIからのデータ取得を簡単にしてくれる「TanStack Query」というライブラリを使います。
このライブラリを使うことで、簡単にAPIからデータを取得してコンポーネントで使うことができます。

`workspaces/app/src/routes/index.tsx`を開いて、次にように変更します。

```tsx title="workspaces/app/src/routes/index.tsx" ins={1-2,11-27}
import type { ListPostsResponse } from "@mcc/schema/api";
import { useQuery } from "@tanstack/react-query";
import { createFileRoute } from "@tanstack/react-router";
import { Post } from "../components/Post";

export const Route = createFileRoute("/")({
	component: Page,
});

function Page() {
	const { data } = useQuery({
		queryKey: ["posts"],
		queryFn: async () => {
			const response = await fetch(
				"https://micro-communication-chat.tuatmcc-com.workers.dev/api/posts",
			);

			if (!response.ok) {
				throw new Error("Failed to fetch posts");
			}

			const data = (await response.json()) as ListPostsResponse;
			return data
		},
	});

	console.log(data);

	return (
		<div className="flex flex-col gap-4">
			<h1>Hello, React!</h1>
			<Post name={"太郎"} content={"こんにちは！"} replies={3} />
			<Post name={"花子"} content={"こんばんは！"} replies={5} />
			<Post name={"太郎"} content={"おはよう！"} replies={7} />
		</div>
	);
}
```

TanStack Queryでは、APIからデータを取得する時に`useQuery`という関数を使います。
`useQuery`には主に2つの設定が必要です。

- `queryKey`: このデータを識別するための名前（今回は`["posts"]`）
- `queryFn`: 実際にAPIからデータを取得する処理

`queryKey`は、TanStack Queryがデータを管理するための目印のようなものです。
重要なのは`queryFn`の部分で、ここに実際のAPI呼び出しの処理を書きます。
詳しく見ていきましょう。

```tsx {3-14}
const { data } = useQuery({
	queryKey: ["posts"],
	queryFn: async () => {
		const response = await fetch(
			"https://micro-communication-chat.tuatmcc-com.workers.dev/api/posts",
		);

		if (!response.ok) {
			throw new Error("Failed to fetch posts");
		}

		const data = (await response.json()) as ListPostsResponse;
		return data.posts;
	},
});
```

`queryFn`の関数をよく見ると、`()`の前に`async`というキーワードがついています。
これは**非同期関数**というもので、時間のかかる処理（APIの呼び出しなど）を扱う時に使います。

API呼び出しは、インターネット越しにデータを取得するため時間がかかります。
その間、画面が固まってしまわないように、「処理が完了するまで待つ」という仕組みが必要になります。
それが`async`と`await`です。

JavaScriptでAPIを呼び出す時は`fetch`関数を使います。
`fetch`の前に`await`をつけることで、「APIの結果が返ってくるまで待つ」ということができます。

`fetch`の結果は`response`という変数に入ります。
`response.ok`で、APIの呼び出しが成功したかどうかをチェックしています。
もし失敗していたら（`ok`が`false`だったら）、`throw`でエラーを発生させて処理を停止します。

APIの呼び出しが成功していれば、`response.json()`でAPIから返されたJSONデータを取得します。
これも時間がかかる処理なので、`await`をつけて結果を待ちます。

`as ListPostsResponse`という部分は、TypeScriptに「このデータはこんな形になっています」と教えるためのものです。
APIから返ってくるデータの形をTypeScriptが自動で判断することはできないので、手動で指定してあげる必要があります。

最後に`return data`でAPIから取得したデータを返しています。

`useQuery`からは色々な情報が返ってきます。
- `data`: APIから取得したデータ
- `isLoading`: 現在データを読み込み中かどうか
- `error`: エラーが発生した場合のエラー情報
など

今回は取得したデータだけを使いたいので、`data`の部分だけを取り出しています。
`data`には、先ほど`queryFn`で`return`した投稿の一覧が入っています。
まずは正しくデータが取得できているか確認するために、`console.log(data)`でコンソールに表示しています。

うまくAPIからデータを取得できているか確認してみましょう。ブラウザの開発者ツールを開いて、「Console」タブを開いてください。
最初に`undefined`と表示され、その後に投稿データの配列が表示されるはずです。

最初に`undefined`が表示されるのは、まだAPIからデータが返ってきていない状態だからです。
少し待つと、実際のデータが表示されます。
コンソールの出力が折りたたまれている場合は、クリックすると詳細を見ることができます。

![](./assets/console-posts.png)

また、「Network」タブを開いてみると、`/api/posts`へのリクエストとそのレスポンスを確認することもできます。

![](./assets/network-posts.png)

さて、これでAPIを叩くことができました。

## タイムラインを表示する

取得したデータを使って、タイムラインを表示してみましょう。

`workspaces/app/src/routes/index.tsx`を次のように変更してください。

```tsx title="workspaces/app/src/routes/index.tsx" ins={14-22} del={6,10-13}
// 省略

function Page() {
	// 省略

	console.log(data);

	return (
		<div className="flex flex-col gap-4">
			<h1>Hello, React!</h1>
      <Post name={"太郎"} content={"こんにちは！"} replies={3} />
      <Post name={"花子"} content={"こんばんは！"} replies={5} />
      <Post name={"太郎"} content={"おはよう！"} replies={7} />
			{data?.posts.map((post) => (
				<Post
					key={post.id}
					name={post.name ?? "名無し"}
					content={post.content}
					likes={post.likes}
					replies={post.replies}
				/>
			))}
		</div>
	);
}
```

このコードの重要なポイントを詳しく見ていきましょう。

まず、APIから取得したデータは投稿の配列になっています。
この配列の中身を一つずつ取り出して、それぞれを`<Post>`コンポーネントとして表示したいと思います。
JavaScriptでは、配列の各要素に対して同じ処理を行いたい時に`.map()`というメソッドを使います。
`data?.posts.map((post) => (...))`の部分では、投稿データの配列から一つずつ投稿を取り出して、それぞれを`<Post>`コンポーネントに変換しています。

ここで`data?.posts`の`?`に注目してください。
これは「オプショナルチェーニング」という機能で、`data`が`undefined`の時にエラーが発生しないようにするためのものです。
APIからデータを取得している間は`data`が`undefined`になるため、`data?.posts`と書くことで、「`data`が存在する場合だけ`posts.map`を実行し、存在しない場合は何も表示しない」という動作になります。

次に、`<Post>`コンポーネントには、APIから取得した各投稿のデータを渡しています。
- `name={post.name ?? "名無し"}`: 投稿者名（ない場合は「名無し」）
- `content={post.content}`: 投稿内容
- `likes={post.likes}`: いいね数
- `replies={post.replies}`: 返信数

ここで`post.name ?? "名無し"`の`??`は、左側が`null`や`undefined`の場合に右側の値を使うという意味です。
投稿者名が設定されていない投稿があるかもしれないので、その場合は「名無し」と表示するようにしています。

また、各`<Post>`に`key={post.id}`というプロパティを設定していることも重要です。
`key`は、Reactが配列の各要素を区別するための特別な目印です。
配列でコンポーネントを表示する時は、必ず一意（重複しない）な`key`を設定する必要があります。
今回は投稿のID（`post.id`）を使用することで、Reactが効率よく画面の更新を行うことができるようになります。

`Post`コンポーネントにlikesを再び渡すようにしたので、`Post`コンポーネントも元に戻します。

```tsx title="workspaces/app/src/components/Post.tsx" ins={7,12,31} del={1,11,13-18,30}
import { useState } from "react";
import { LuHeart, LuMessageCircle } from "react-icons/lu";

interface Props {
  name: string;
  content: string;
  likes: number;
  replies: number;
}

export function Post({ name, content, likes, replies }: Props) {
export function Post({ name, content, replies }: Props) {
  const [likes, setLikes] = useState(0);
  const handleClick = () => {
    console.log("いいねしました");
    setLikes(likes + 1); // いいね数を1増やす
  };

	return (
		<article className="card flex flex-col gap-2">
			<div className="flex items-center gap-2">
				<span className="size-8 rounded-full bg-slate-300" />
				<span>{name}</span>
			</div>

			<p className="whitespace-pre-wrap">{content}</p>

			<div className="flex gap-4 text-slate-500">
				<div className="flex items-center gap-1">
					<button type="button" onClick={handleClick}>
					<button type="button">
						<LuHeart className="size-6" title="いいね" />
					</button>
					<span>{likes}</span>
				</div>
				<div className="flex items-center gap-1">
					<div>
						<LuMessageCircle className="size-6" title="返信" />
					</div>
					<span>{replies}</span>
				</div>
			</div>
		</article>
	);
}
```

ブラウザを確認すると、タイムラインが表示されているはずです。

![](./assets/timeline.png)

## これまでのコード

これまでのコードをまとめておきます。

```tsx title="workspaces/app/src/routes/index.tsx"
import type { ListPostsResponse } from "@mcc/schema/api";
import { useQuery } from "@tanstack/react-query";
import { createFileRoute } from "@tanstack/react-router";
import { Post } from "../components/Post";

export const Route = createFileRoute("/")({
	component: Page,
});

function Page() {
	const { data } = useQuery({
		queryKey: ["posts"],
		queryFn: async () => {
			const response = await fetch(
				"https://micro-communication-chat.tuatmcc-com.workers.dev/api/posts",
			);

			if (!response.ok) {
				throw new Error("Failed to fetch posts");
			}

			const data = (await response.json()) as ListPostsResponse;
			return data;
		},
	});

	return (
		<div className="flex flex-col gap-4">
			{data?.posts.map((post) => (
				<Post
					key={post.id}
					name={post.name ?? "名無し"}
					content={post.content}
					likes={post.likes}
					replies={post.replies}
				/>
			))}
		</div>
	);
}
```

```tsx title="workspaces/app/src/components/Post.tsx"
import { LuHeart, LuMessageCircle } from "react-icons/lu";

interface Props {
	name: string;
	content: string;
	likes: number;
	replies: number;
}

export function Post({ name, content, likes, replies }: Props) {
	return (
		<article className="card flex flex-col gap-2">
			<div className="flex items-center gap-2">
				<span className="size-8 rounded-full bg-slate-300" />
				<span>{name}</span>
			</div>

			<p className="whitespace-pre-wrap">{content}</p>

			<div className="flex gap-4 text-slate-500">
				<div className="flex items-center gap-1">
					<button type="button">
						<LuHeart className="size-6" title="いいね" />
					</button>
					<span>{likes}</span>
				</div>
				<div className="flex items-center gap-1">
					<div>
						<LuMessageCircle className="size-6" title="返信" />
					</div>
					<span>{replies}</span>
				</div>
			</div>
		</article>
	);
}
```
